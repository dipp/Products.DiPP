<html xmlns:tal="http://xml.zope.org/namespaces/tal"
    xmlns:metal="http://xml.zope.org/namespaces/metal"
    i18n:domain="DiPP">
    <body>
        <tal:comment>
            The calling template must define the value for 'issue_path' otherwise the catalog
            query fails. We want to use this template to display the latest issue on the homepage
            and also in the issue_view itself.
        </tal:comment>
        <div metal:define-macro="table_of_contents"
             tal:define="avtm                      python:here.portal_vocabularies;
                         journalsections           python:avtm.getVocabularyByName('journal-sections');
                         section_dict              python:journalsections.getVocabularyDict(journalsections);
                         articles                  python: here.portal_catalog(path=issue_path,portal_type='FedoraArticle');
                         issue_show_abstracts      here/issue_show_abstracts|here/portal_properties/dipp_properties/issue_show_abstracts|nothing;
                         issue_show_full_abstracts here/issue_show_full_abstracts|here/portal_properties/dipp_properties/issue_show_full_abstracts|nothing"
             i18n:domain="dipp">
            
            <p class="discreet"
                 tal:condition="not:articles">
                 This Issue does not contain any articles.
            </p>
            
            <div tal:repeat="section python: section_dict.keys()">
                <tal:block tal:define="articles python: here.portal_catalog(path = {'query':issue_path, 'depth':1},portal_type='FedoraArticle',getJournal_section=section, sort_on='getObjPositionInParent')"
                           tal:condition="articles"
                           i18n:domain="dipp">
                <h2 tal:condition="python: section != 'no-section'"
                    tal:content="python: section_dict[section]"
                    tal:attributes="id section">
                    The name of the section
                </h2>
                <ol class="issue_content" >
                    
                    <tal:items tal:repeat="item articles">
                       <li tal:define="oddrow               repeat/item/odd;
                                       obj                  item/getObject;
                                       item_url             item/getURL|item/absolute_url;
                                       item_id              item/getId;
                                       item_section         item/getJournal_section;
                                       item_path            item/getPath|python:'/'.join(item.getPhysicalPath());
                                       item_title_or_id     item/pretty_title_or_id;
                                       item_section         item/getJournal_section|nothing;
                                       item_abstracts       python:obj.getAvailableAbstracts;
                                       item_abstract        obj/getAbstract;
                                       item_contributors    python:obj.Contributors();
                                       item_wf_state        item/review_state|python: wtool.getInfoFor(item, 'review_state', '');
                                       item_wf_state_class python:'state-' + normalizeString(item_wf_state);
                                       authors              item_contributors"
                                       tal:attributes="class python:test(oddrow, 'even', 'odd')">
                            <strong>    
                                <a href="#"
                                   tal:content="item_title_or_id"
                                   tal:attributes="href item_url;
                                           class string:$item_wf_state_class">
                                 Article title</a>

                            </strong>
                            <p tal:condition="issue_show_full_abstracts"
                               tal:content="item_abstract">
                            </p>
                            <div class="abstracts"
                                tal:define="lang_dict   python:here.fedora.getLanguages()"
                                tal:condition="python: issue_show_abstracts and len(item_abstracts())>0">
                                <span i18n:translate="abstract_available">Abstracts available in</span>
                                <tal:block tal:repeat="abstract item_abstracts">
                                    <a href="#"
                                       tal:define="title python:lang_dict[abstract]"
                                       tal:attributes="href string:$item_url/abstract_view?lang=$abstract;
                                                       title abstract"
                                       tal:content="title"></a><span tal:condition="not: repeat/abstract/end">,</span>
                                </tal:block>
                            </div>
                            <div metal:use-macro="here/article_authors/macros/article_authors">
                                A nicely formatted list of authors
                            </div>
                        </li>
                     </tal:items>
                </ol>

                </tal:block>

            </div>
        </div>

     </body>
</html>
